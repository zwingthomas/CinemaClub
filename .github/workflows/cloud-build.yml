name: Cloud Build

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main
  workflow_dispatch:

permissions:
  contents: read
  id-token: write

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      PROJECT_ID: ${{ vars.GCP_PROJECT_ID || secrets.GCP_PROJECT_ID }}
      GAR_REGION: ${{ vars.GAR_REGION || secrets.GAR_REGION }}
      GAR_REPOSITORY: ${{ vars.GAR_REPOSITORY || secrets.GAR_REPOSITORY }}
      VITE_API_BASE_URL: ${{ vars.VITE_API_BASE_URL || secrets.VITE_API_BASE_URL }}
      BUILD_SERVICE_ACCOUNT: ${{ secrets.GCP_SERVICE_ACCOUNT || vars.GCP_SERVICE_ACCOUNT }}
      RUN_REGION: ${{ vars.RUN_REGION || secrets.RUN_REGION || vars.GAR_REGION || secrets.GAR_REGION }}
      BACKEND_SERVICE: ${{ vars.BACKEND_SERVICE || secrets.BACKEND_SERVICE || 'cinemaclub-backend' }}
      FRONTEND_SERVICE: ${{ vars.FRONTEND_SERVICE || secrets.FRONTEND_SERVICE || 'cinemaclub-frontend' }}
      RUN_SERVICE_ACCOUNT: ${{ vars.RUN_SERVICE_ACCOUNT || secrets.RUN_SERVICE_ACCOUNT || secrets.GCP_SERVICE_ACCOUNT || vars.GCP_SERVICE_ACCOUNT }}
      FRONTEND_ORIGIN: ${{ vars.FRONTEND_ORIGIN || secrets.FRONTEND_ORIGIN || 'http://localhost:5173' }}
      SUPABASE_URL: ${{ secrets.SUPABASE_URL || vars.SUPABASE_URL }}
      SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SECRET_KEY || secrets.SUPABASE_SERVICE_ROLE_KEY || vars.SUPABASE_SECRET_KEY || vars.SUPABASE_SERVICE_ROLE_KEY }}
      SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_PUBLISHABLE_KEY || secrets.SUPABASE_ANON_KEY || vars.SUPABASE_PUBLISHABLE_KEY || vars.SUPABASE_ANON_KEY }}
      STRIPE_SECRET_KEY: ${{ secrets.STRIPE_SECRET_KEY || vars.STRIPE_SECRET_KEY }}
      STRIPE_PRICE_DEFAULT: ${{ vars.STRIPE_PRICE_DEFAULT || secrets.STRIPE_PRICE_DEFAULT || '1200' }}
      STRIPE_CURRENCY: ${{ vars.STRIPE_CURRENCY || secrets.STRIPE_CURRENCY || 'usd' }}
      MUX_TOKEN_ID: ${{ secrets.MUX_TOKEN_ID || vars.MUX_TOKEN_ID }}
      MUX_TOKEN_SECRET: ${{ secrets.MUX_TOKEN_SECRET || vars.MUX_TOKEN_SECRET }}
      TAG: ${{ github.sha }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate config
        run: |
          if [ -z "${PROJECT_ID}" ]; then
            echo "PROJECT_ID is empty. Set repo variable or secret GCP_PROJECT_ID to your GCP project ID." >&2
            exit 1
          fi
          if [ -z "${GAR_REGION}" ] || [ -z "${GAR_REPOSITORY}" ]; then
            echo "GAR_REGION or GAR_REPOSITORY is empty. Set repo variables or secrets accordingly." >&2
            exit 1
          fi
          if [ -z "${RUN_REGION}" ]; then
            echo "RUN_REGION is empty. Set repo variable RUN_REGION (defaults to GAR_REGION if set)." >&2
            exit 1
          fi
          if [ -z "${RUN_SERVICE_ACCOUNT}" ]; then
            echo "RUN_SERVICE_ACCOUNT is empty. Set repo variable or secret RUN_SERVICE_ACCOUNT to the Cloud Run runtime service account email." >&2
            exit 1
          fi
          if [ -z "${SUPABASE_URL}" ] || [ -z "${SUPABASE_SERVICE_ROLE_KEY}" ]; then
            echo "SUPABASE_URL or SUPABASE_SERVICE_ROLE_KEY is empty. Set secrets for Supabase so the API can start." >&2
            exit 1
          fi

      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          workload_identity_provider: ${{ secrets.GCP_WORKLOAD_IDENTITY_PROVIDER }}
          service_account: ${{ secrets.GCP_SERVICE_ACCOUNT }}

      - name: Setup gcloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ env.PROJECT_ID }}

      - name: Run Cloud Build
        run: |
          SA_FLAG=""
          if [ -n "${BUILD_SERVICE_ACCOUNT}" ]; then
            SA_RESOURCE="projects/${PROJECT_ID}/serviceAccounts/${BUILD_SERVICE_ACCOUNT}"
            SA_FLAG="--service-account=${SA_RESOURCE}"
          fi
          gcloud builds submit . \
            --project="${PROJECT_ID}" \
            --config=cloudbuild.yaml \
            ${SA_FLAG} \
            --substitutions=_REGION=${GAR_REGION},_REPOSITORY=${GAR_REPOSITORY},_VITE_API_BASE_URL=${VITE_API_BASE_URL},_TAG=${TAG},_RUN_REGION=${RUN_REGION},_BACKEND_SERVICE=${BACKEND_SERVICE},_FRONTEND_SERVICE=${FRONTEND_SERVICE},_RUN_SERVICE_ACCOUNT=${RUN_SERVICE_ACCOUNT},_FRONTEND_ORIGIN=${FRONTEND_ORIGIN},_SUPABASE_URL=${SUPABASE_URL},_SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY},_SUPABASE_ANON_KEY=${SUPABASE_ANON_KEY},_STRIPE_SECRET_KEY=${STRIPE_SECRET_KEY},_STRIPE_PRICE_DEFAULT=${STRIPE_PRICE_DEFAULT},_STRIPE_CURRENCY=${STRIPE_CURRENCY},_MUX_TOKEN_ID=${MUX_TOKEN_ID},_MUX_TOKEN_SECRET=${MUX_TOKEN_SECRET}
