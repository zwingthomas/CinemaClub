steps:
  - name: gcr.io/cloud-builders/docker
    id: backend
    args:
      - build
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/backend:${_TAG}
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/backend:latest
      - backend

  - name: gcr.io/cloud-builders/docker
    id: push-backend-tag
    args:
      - push
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/backend:${_TAG}

  - name: gcr.io/cloud-builders/docker
    id: push-backend-latest
    args:
      - push
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/backend:latest

  - name: gcr.io/cloud-builders/docker
    id: frontend
    args:
      - build
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/frontend:${_TAG}
      - -t
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/frontend:latest
      - --build-arg
      - VITE_API_BASE_URL=${_VITE_API_BASE_URL}
      - frontend

  - name: gcr.io/cloud-builders/docker
    id: push-frontend-tag
    args:
      - push
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/frontend:${_TAG}

  - name: gcr.io/cloud-builders/docker
    id: push-frontend-latest
    args:
      - push
      - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/frontend:latest

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: deploy-backend
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_BACKEND_SERVICE}
      - --image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/backend:${_TAG}
      - --region=${_RUN_REGION}
      - --platform=managed
      - --allow-unauthenticated
      - --set-env-vars=FRONTEND_ORIGIN=${_FRONTEND_ORIGIN},SUPABASE_URL=${_SUPABASE_URL},SUPABASE_SERVICE_ROLE_KEY=${_SUPABASE_SERVICE_ROLE_KEY},SUPABASE_ANON_KEY=${_SUPABASE_ANON_KEY},STRIPE_SECRET_KEY=${_STRIPE_SECRET_KEY},STRIPE_PRICE_DEFAULT=${_STRIPE_PRICE_DEFAULT},STRIPE_CURRENCY=${_STRIPE_CURRENCY},MUX_TOKEN_ID=${_MUX_TOKEN_ID},MUX_TOKEN_SECRET=${_MUX_TOKEN_SECRET}
      - --service-account=${_RUN_SERVICE_ACCOUNT}

  - name: gcr.io/google.com/cloudsdktool/cloud-sdk
    id: deploy-frontend
    entrypoint: gcloud
    args:
      - run
      - deploy
      - ${_FRONTEND_SERVICE}
      - --image=${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/frontend:${_TAG}
      - --region=${_RUN_REGION}
      - --platform=managed
      - --allow-unauthenticated
      - --service-account=${_RUN_SERVICE_ACCOUNT}

images:
  - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/backend:${_TAG}
  - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/backend:latest
  - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/frontend:${_TAG}
  - ${_REGION}-docker.pkg.dev/$PROJECT_ID/${_REPOSITORY}/frontend:latest

substitutions:
  _REGION: us-central1
  _REPOSITORY: cinemaclub
  _VITE_API_BASE_URL: http://backend:4000/api
  _TAG: dev
  _RUN_REGION: us-central1
  _BACKEND_SERVICE: cinemaclub-backend
  _FRONTEND_SERVICE: cinemaclub-frontend
  _RUN_SERVICE_ACCOUNT: REPLACE_ME_RUN_SA
  _FRONTEND_ORIGIN: http://localhost:5173
  _SUPABASE_URL: ""
  _SUPABASE_SERVICE_ROLE_KEY: ""
  _SUPABASE_ANON_KEY: ""
  _STRIPE_SECRET_KEY: ""
  _STRIPE_PRICE_DEFAULT: "1200"
  _STRIPE_CURRENCY: "usd"
  _MUX_TOKEN_ID: ""
  _MUX_TOKEN_SECRET: ""

options:
  logging: CLOUD_LOGGING_ONLY
